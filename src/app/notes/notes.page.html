<div class="max-w-6xl mx-auto">


  <!-- Create Note -->
  <div class="bg-white mx-auto max-w-xl rounded shadow-md shadow-gray-300 p-3 mb-8 relative"
    (click)="expandNote($event)">

    <!-- Title input -->
    <input *ngIf="isExpanded" [(ngModel)]="newNote.title" placeholder="Title"
      class="w-full font-semibold text-lg mb-2 outline-none" />

    <!-- Description textarea -->
    <textarea [(ngModel)]="newNote.description" placeholder="Take a note..." class="w-full resize-none outline-none"
      [rows]="isExpanded ? 3 : 1" #newNoteTextarea (input)="autoGrow(newNoteTextarea)">
  </textarea>

    <!-- Color palette & Save button -->
    <div *ngIf="isExpanded" class="flex justify-between items-center mt-2">

      <!-- Color palette -->
      <div class="relative">
        <button (click)="toggleCreateColorPalette()" class="p-1 rounded hover:bg-gray-100">
          <img src="icons/palette.svg" class="w-5 h-5" />
        </button>

        <div *ngIf="showCreateColorPalette"
          class="absolute z-10 flex gap-2 bg-white border rounded-full p-2 shadow-md mt-2">
          <button *ngFor="let color of colors" class="w-6 h-6 rounded-full border hover:scale-110 transition"
            [ngStyle]="{ 'background-color': color }" (click)="selectCreateColor(color)">
          </button>
        </div>
      </div>

      <!-- Save button -->
      <button class="text-sm text-blue-600 font-medium" (click)="addNote()">
        Close
      </button>
    </div>
  </div>


  <!-- Notes Grid -->
  <!-- PINNED NOTES -->
  <div *ngIf="pinnedNotes.length > 0" class="mb-6">
    <p class="text-xs text-gray-500 font-semibold mb-2 px-1">PINNED</p>

    <div class="grid gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 items-start">
      <ng-container *ngFor="let note of pinnedNotes; trackBy: trackById">
        <div class="group relative rounded-lg p-4 shadow-sm transition-all duration-300 hover:shadow-md"
          [ngStyle]="{ 'background-color': note.color || '#fff' }" [class.z-50]="activeColorPickerNoteId === note.id">

          <!-- TITLE + PIN -->
          <div class="flex items-start">
            <input [(ngModel)]="note.title" class="w-full font-semibold text-lg bg-transparent outline-none"
              (blur)="updateNote(note)" />

            <button (click)="togglePin(note)" class="p-1 opacity-0 group-hover:opacity-100 transition duration-200">
              <!-- PINNED SVG -->
              <svg width="20" height="20" viewBox="0 0 24 24" class="text-gray-700">
                <path d="M17 4v7l2 3v2h-6v5l-1 1-1-1v-5H5v-2l2-3V4c0-1.1.9-2 2-2h6c1.11 0 2 .89 2 2z"
                  fill="currentColor" />
              </svg>
            </button>
          </div>

          <textarea #noteTextarea [(ngModel)]="note.description" (input)="autoGrow($event); updateNote(note)"
            class="w-full bg-transparent resize-none outline-none mt-2" rows="3" (blur)="updateNote(note)">
          </textarea>

          <!-- Labels -->
          <div *ngIf="note.labels && note.labels.length > 0" class="flex flex-wrap gap-2 mt-2">
            <span *ngFor="let label of note.labels" class="text-xs px-2 py-1 bg-gray-200 rounded-full">
              {{ label.labelName }}
            </span>
          </div>

          <div
            class="flex justify-between items-center mt-3 text-sm opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-200 ease-out">

            <div class="w-full flex justify-between gap-3">

              <div class="relative">
                <!-- Color Icon -->
                <button (click)="toggleNoteColorPicker(note.id)" class="p-1 rounded hover:bg-gray-100">
                  <img src="icons/palette.svg" class="w-5 h-5" />
                </button>

                <!-- Palette -->
                <div *ngIf="activeColorPickerNoteId === note.id"
                  class="absolute bottom-8 left-0 z-10 flex gap-2 bg-white border rounded-full p-2 shadow-md">
                  <button *ngFor="let color of colors" class="w-6 h-6 rounded-full border hover:scale-110 transition"
                    [ngStyle]="{ 'background-color': color }" (click)="selectNoteColor(note, color)">

                  </button>
                </div>
              </div>

              <!-- Label Icon -->
              <div class="relative">
                <button (click)="toggleLabelPicker(note.id); $event.stopPropagation()" class="p-1 rounded hover:bg-gray-100">
                  <img src="icons/label.svg" class="w-5 h-5" />
                </button>

                <!-- Label Picker Dropdown -->
                <div *ngIf="activeLabelPickerNoteId === note.id"
                  class="absolute bottom-8 left-0 z-20 bg-white border rounded shadow-lg p-2 min-w-[200px] max-h-[300px] overflow-y-auto">
                  <p class="text-xs text-gray-500 font-semibold mb-2 px-2">Label note</p>
                  <div *ngFor="let label of allLabels" 
                    class="flex items-center gap-2 px-2 py-1 hover:bg-gray-100 cursor-pointer rounded"
                    (click)="toggleNoteLabel(note, label, $event)">
                    <input type="checkbox" [checked]="hasLabel(note, label.labelId)" class="pointer-events-none"/>
                    <span class="text-sm">{{ label.labelName }}</span>
                  </div>
                  <div *ngIf="allLabels.length === 0" class="text-sm text-gray-500 px-2 py-2">
                    No labels yet. Create one in Edit Labels.
                  </div>
                </div>
              </div>

              <div class="flex gap-3">
                <button (click)="toggleArchive(note)">
                  <img src="icons/archive.svg" alt="archive" class="w-5 h-5">
                </button>
                <button (click)="deleteNote(note)">
                  <img src="icons/delete.svg" alt="delete" class="w-5 h-5">
                </button>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- OTHER NOTES -->
  <div>
    <p *ngIf="pinnedNotes.length > 0" class="text-xs text-gray-500 font-semibold mb-2 px-1">
      OTHERS
    </p>

    <div class="grid gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 items-start">
      <ng-container *ngFor="let note of otherNotes; trackBy: trackById">
        <div class="group relative rounded-lg p-4 shadow-sm transition-all duration-300 hover:shadow-md"
          [ngStyle]="{ 'background-color': note.color || '#fff' }" [class.z-50]="activeColorPickerNoteId === note.id">

          <div class="flex items-start">
            <input [(ngModel)]="note.title" class="w-full font-semibold text-lg bg-transparent outline-none"
              (blur)="updateNote(note)" />

            <button (click)="togglePin(note)" class="p-1 opacity-0 group-hover:opacity-100 transition duration-200">
              <!-- UNPINNED SVG -->
              <svg width="20" height="20" viewBox="0 0 24 24" class="text-gray-500 hover:text-gray-700">
                <path
                  d="M17 4v7l2 3v2h-6v5l-1 1-1-1v-5H5v-2l2-3V4c0-1.1.9-2 2-2h6c1.11 0 2 .89 2 2zM9 4v7.75L7.5 14h9L15 11.75V4H9z"
                  fill="currentColor" />
              </svg>
            </button>
          </div>

          <textarea #noteTextarea [(ngModel)]="note.description" (input)="autoGrow($event); updateNote(note)"
            class="w-full bg-transparent resize-none outline-none mt-2" rows="3" (blur)="updateNote(note)"></textarea>

          <!-- Labels -->
          <div *ngIf="note.labels && note.labels.length > 0" class="flex flex-wrap gap-2 mt-2">
            <span *ngFor="let label of note.labels" class="text-xs px-2 py-1 bg-gray-200 rounded-full">
              {{ label.labelName }}
            </span>
          </div>

          <div
            class="flex justify-between items-center mt-3 text-sm opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition-all duration-200 ease-out">

            <div class="w-full flex justify-between gap-3">

              <div class="relative">
                <!-- Color Icon -->
                <button (click)="toggleNoteColorPicker(note.id); $event.stopPropagation()"
                  class="p-1 rounded hover:bg-gray-100">
                  <img src="icons/palette.svg" class="w-5 h-5" />
                </button>

                <!-- Color Palette -->
                <div *ngIf="activeColorPickerNoteId === note.id"
                  class="absolute z-10 flex gap-2 bg-white border rounded-full p-2 shadow-md mt-2">
                  <button *ngFor="let color of colors" class="w-6 h-6 rounded-full border hover:scale-110 transition"
                    [ngStyle]="{ 'background-color': color }" (click)="selectNoteColor(note, color)"></button>
                </div>
              </div>

              <!-- Label Icon -->
              <div class="relative">
                <button (click)="toggleLabelPicker(note.id); $event.stopPropagation()" class="p-1 rounded hover:bg-gray-100">
                  <img src="icons/label.svg" class="w-5 h-5" />
                </button>

                <!-- Label Picker Dropdown -->
                <div *ngIf="activeLabelPickerNoteId === note.id"
                  class="absolute bottom-8 left-0 z-20 bg-white border rounded shadow-lg p-2 min-w-[200px] max-h-[300px] overflow-y-auto">
                  <p class="text-xs text-gray-500 font-semibold mb-2 px-2">Label note</p>
                  <div *ngFor="let label of allLabels" 
                    class="flex items-center gap-2 px-2 py-1 hover:bg-gray-100 cursor-pointer rounded"
                    (click)="toggleNoteLabel(note, label, $event)">
                    <input type="checkbox" [checked]="hasLabel(note, label.labelId)" class="pointer-events-none"/>
                    <span class="text-sm">{{ label.labelName }}</span>
                  </div>
                  <div *ngIf="allLabels.length === 0" class="text-sm text-gray-500 px-2 py-2">
                    No labels yet. Create one in Edit Labels.
                  </div>
                </div>
              </div>

              <div class="flex gap-3">
                <button (click)="toggleArchive(note)">
                  <img src="icons/archive.svg" alt="archive" class="w-5 h-5">
                </button>
                <button (click)="deleteNote(note)">
                  <img src="icons/delete.svg" alt="delete" class="w-5 h-5">
                </button>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

</div>